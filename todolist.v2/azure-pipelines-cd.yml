name: CD-$(Date:yyyyMMdd)-$(Rev:.r)

trigger: none   # CD –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–∑ CI —á–µ—Ä–µ–∑ pipeline resource

resources:
  pipelines:
    - pipeline: todolist-ci   # –∏–º—è CI –ø–∞–π–ø–ª–∞–π–Ω–∞
      source: sudolicious.todolist  # –Ω–∞–∑–≤–∞–Ω–∏–µ CI pipeline –≤ Azure DevOps
      trigger: true           # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º CI

pool: Default

stages:
- stage: Deploy
  displayName: "üöÄ Deploy to Kubernetes"
  jobs:
  - job: HelmUpgrade
    displayName: "Helm upgrade todolist"
    steps:
    - checkout: self
      displayName: "Checkout repo with Helm chart"

    - download: todolist-ci
      artifact: version-info
      displayName: "Download version info from CI"

    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "Deploying version: $APP_VERSION"

        # –û–±–Ω–æ–≤–ª—è–µ–º Helm release
        helm upgrade todolist ./todolist.v2/backend \
          --install \
          --namespace todolist \
          --create-namespace \
          --set image.repository=$(imageName) \
          --set image.tag=$APP_VERSION

        echo "‚úÖ Helm release updated: $APP_VERSION"
      displayName: "Run helm upgrade"

